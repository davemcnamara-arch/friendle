<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendle - Match Activities with Friends</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            height: 100%;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .page.active {
            display: block;
        }

        .page#chat.active {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            color: #666;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #activity-search {
            margin-bottom: 20px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .btn-small {
            width: auto;
            padding: 10px 20px;
            font-size: 0.9em;
            margin-top: 0;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            background: #f8f9fa;
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .circle-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .circle-card .main-content {
            cursor: pointer;
        }

        .circle-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .circle-name {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .circle-members {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .circle-code {
            background: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8em;
            color: #555;
            text-align: center;
            margin-top: 10px;
        }
        
        .circle-code strong {
            letter-spacing: 2px;
            font-size: 1.1em;
            color: #667eea;
        }

        .activities-grid, .frequent-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #555;
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #f0f0f0;
        }

        .activity-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .activity-card.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .activity-emoji {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .activity-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .bulk-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .bulk-controls h4 {
            margin-bottom: 10px;
            color: #555;
        }

        .bulk-btn {
            display: inline-block;
            padding: 8px 12px;
            margin: 5px 5px 5px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bulk-btn:hover {
            background: #667eea;
            color: white;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            flex-shrink: 0;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .scheduled-event-banner {
            padding: 10px;
            background-color: #e6f7ff;
            border-bottom: 1px solid #91d5ff;
            text-align: center;
            font-size: 0.9em;
            color: #0050b3;
            flex-shrink: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-actions {
    position: relative;
}

.message-actions-btn {
    background: none;
    border: none;
    color: #aaa;
    cursor: pointer;
    font-size: 1.2em;
    padding: 5px;
}

.message-actions-menu {
    position: absolute;
    bottom: 25px;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: none;
    width: 100px;
    z-index: 10;
}

.message-actions-menu button {
    display: block;
    width: 100%;
    padding: 10px;
    background: none;
    border: none;
    text-align: left;
    cursor: pointer;
}

.message-actions-menu button:hover {
    background: #f8f9fa;
}

        .message.own {
            flex-direction: row-reverse;
        }
        
        .message.system {
            justify-content: center;
            font-size: 0.8em;
            color: #888;
            margin: 20px 0;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 80%;
        }

        .message-sender {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 4px;
            padding: 0 12px;
        }

        .message.own .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .message-bubble {
            background: white;
            padding: 12px 15px;
            border-radius: 15px;
            position: relative;
        }

        .message.own .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message-photo {
            max-width: 200px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-photo:hover {
            transform: scale(1.05);
        }

        .message-location {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .message-actions {
            position: relative;
        }

        .message-actions-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
        }
        
        .message-actions-menu {
            position: absolute;
            bottom: 25px;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            width: 100px;
            z-index: 10;
        }

        .message-actions-menu button {
            display: block;
            width: 100%;
            padding: 10px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
        }
        .message-actions-menu button:hover {
            background: #f8f9fa;
        }

        .chat-input {
            background: white;
            padding: 15px;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .chat-input-top-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .chat-input input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            min-width: 50px;
        }
        
        .attachment-btn {
            background: #f8f9fa;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1.2em;
        }
        
        .attachment-btn:hover {
            background: #e9ecef;
        }

        .send-btn {
            margin: 0;
        }

        .bottom-nav {
            position: relative;
            width: 100%;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            flex-shrink: 0;
        }

        .nav-item {
            text-align: center;
            cursor: pointer;
            transition: color 0.2s;
            flex: 1;
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: calc(50% - 20px);
            width: 10px;
            height: 10px;
            background-color: #ff4d4f;
            border-radius: 50%;
            border: 2px solid white;
            display: none;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item .nav-icon {
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .nav-item .nav-label {
            font-size: 0.7em;
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 90%;
            width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-image-content {
            background: transparent;
            padding: 0;
            box-shadow: none;
        }

        .modal-image {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2em;
            cursor: pointer;
            z-index: 2001;
        }
        
        .modal-content .close-modal-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5em;
            color: #aaa;
            cursor: pointer;
        }

        .modal-header {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .undo-container {
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 40px);
    max-width: 360px;
    background-color: #333;
    color: white;
    padding: 15px;
    border-radius: 10px;
    display: none;
    justify-content: space-between;
    align-items: center;
    z-index: 1001; /* Higher than the save button */
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

        .undo-btn {
            background: none;
            border: none;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
        }

.sticky-save {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 40px);
    max-width: 360px;
    z-index: 100;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.sticky-save:hover {
    transform: translateX(-50%) translateY(-2px);
    box-shadow: 0 3px 15px rgba(102, 126, 234, 0.4);
}

#manage-activities-grid {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.message-timestamp {
            color: #999;
            font-size: 0.7em;
            margin-left: 8px;
        }

#manage-activities-grid .activities-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 10px;
    margin-bottom: 20px;
}

#manage-activities-grid h3 {
    font-size: 1em;
    font-weight: 600;
    color: #555;
    margin: 15px 0 10px 0;
    padding-bottom: 5px;
    border-bottom: 1px solid #f0f0f0;
}

#manage-activities-grid h3:first-child {
    margin-top: 0;
}

#manage-activities-modal-overlay .modal-content {
    max-height: 80vh;
    overflow-y: auto;
}

#manage-activities-grid .activity-card {
    padding: 8px !important;
    font-size: 0.75em !important;
    min-height: 60px !important;
    max-height: 60px !important;
    width: 100% !important;
}

#manage-activities-grid .activity-emoji {
    font-size: 1.1em !important;
    margin-bottom: 4px !important;
}

#manage-activities-grid .activity-name {
    font-size: 0.75em !important;
    line-height: 1.1 !important;
    margin: 0 !important;
}

#manage-activities-modal-overlay #manage-activities-grid {
    display: block !important;
    grid-template-columns: unset !important;
}

    </style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://kxsewkjbhxtfqbytftbu.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4c2V3a2piaHh0ZnFieXRmdGJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTE4ODQsImV4cCI6MjA3NDQyNzg4NH0.-A-7VOQWOaQqYOO6NxiKxGywddfS-pmwvzHISJqz2AQ";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

</head>
<body>
    <div class="app-container">
        <div id="pages-container" style="flex: 1; overflow-y: auto; position: relative;">
            <div id="welcome" class="page active">
    <div class="header"><div class="logo">‚≠ï Friendle</div><div class="tagline">What do you feel like doing?</div></div>
    
    <div id="login-form">
        <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" placeholder="Enter your email"></div>
        <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" placeholder="Enter your password"></div>
        <button class="btn" onclick="signIn()">Sign In</button>
        <button class="btn btn-secondary" onclick="showRegister()">Create Account</button>
    </div>
    
    <div id="register-form" style="display: none;">
        <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" placeholder="Enter your email"></div>
        <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" placeholder="Create a password (6+ characters)"></div>
        <div class="form-group"><label for="register-name">Your Name</label><input type="text" id="register-name" placeholder="Enter your name"></div>
        <div class="form-group"><label>Choose Your Avatar</label><div class="avatar-grid">
            <div class="avatar-option" data-avatar="üòä">üòä</div><div class="avatar-option" data-avatar="üåü">üåü</div><div class="avatar-option" data-avatar="ü¶Ñ">ü¶Ñ</div><div class="avatar-option" data-avatar="üê®">üê®</div>
            <div class="avatar-option" data-avatar="üéÆ">üéÆ</div><div class="avatar-option" data-avatar="üé®">üé®</div><div class="avatar-option" data-avatar="‚ö°">‚ö°</div><div class="avatar-option" data-avatar="üåô">üåô</div>
        </div></div>
        <button class="btn" onclick="signUp()">Create Account</button>
        <button class="btn btn-secondary" onclick="showLogin()">Back to Sign In</button>
    </div>
</div>
            <div id="circles" class="page"><div class="header"><div class="logo">‚≠ï Circles</div><div class="tagline">Who do you want to hang with?</div></div><div id="circles-list"></div><button class="btn" onclick="showCreateCircle()">Create New Circle</button><button class="btn btn-secondary" onclick="showJoinCircle()">Join Circle</button></div>
            <div id="activities" class="page">
    <div class="header">
        <div class="logo" id="activity-circle-name">‚≠ï Activities</div><div class="tagline">What do you want to do?</div>
    </div>
    <div class="form-group">
        <input type="text" id="activity-search" placeholder="üîç Search for an activity..." onkeyup="handleSearch(event)">
    </div>
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-secondary btn-small" onclick="openSuggestModal()" style="flex: 1;">üí° Suggest a New Activity</button>
        <button class="btn btn-secondary btn-small" onclick="openManageActivitiesModal()" style="flex: 1;">Manage Activities</button>
    </div>
    
                <div id="frequent-section"><div class="section-title">‚≠ê Frequently Used</div><div class="frequent-grid" id="frequent-grid"></div></div>
                <div class="section-title">All Activities</div>
                <div class="bulk-controls"><h4>Quick Select</h4><div class="bulk-btn" onclick="selectBulk('food')">Food & Drinks</div><div class="bulk-btn" onclick="selectBulk('active')">Active</div><div class="bulk-btn" onclick="selectBulk('entertainment')">Entertainment</div><div class="bulk-btn" onclick="selectBulk('relax')">Relax & Creative</div><div class="bulk-btn" onclick="selectBulk('clear')">Clear All</div></div>
                <div class="activities-grid" id="activities-grid"></div>
                <button class="btn sticky-save" onclick="saveActivities()">Save Preferences</button>
                
            </div>
            <div id="matches" class="page">
    <div class="header">
        <div class="logo">‚≠ï Matches</div>
        <div class="tagline">Who else wants to do what you want to do?</div>
        <div style="margin-top: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: #666;">
                <input type="checkbox" id="show-past-events" checked onchange="window.renderMatches()">
                Show past events
            </label>
        </div>
    </div>
    <div id="matches-list"></div>
</div>
            <div id="chat" class="page">
                <div class="chat-container">
                    <div class="chat-header">
    <div class="chat-avatar" id="chat-avatar">üòä</div>
    <div style="flex: 1;">
        <div id="chat-name">Friend Name</div>
        <div style="font-size: 0.8em; opacity: 0.8;" id="chat-activity">Activity</div>
    </div>
    <button onclick="leaveChat()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em;">Change of Plans</button>
</div>
                    <div id="scheduled-event-banner-container"></div>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input">
                        <div class="chat-input-top-row">
                            <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleMessageKeyPress(event)">
                            <button class="attachment-btn" onclick="sharePhoto()">üì∑</button>
                            <button class="attachment-btn" onclick="shareLocation()">üìç</button>
                            <button class="attachment-btn" onclick="findNearbyPlaces()">üîé</button>
                            <button class="attachment-btn" onclick="openDateModal()">üìÖ</button>
                        </div>
                        <button class="btn send-btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            <div id="settings" class="page">
            <div class="header"><div class="logo">‚≠ï Settings</div><div class="tagline">Manage your preferences</div></div>
    <div style="text-align: center; margin: 40px 0;"><div id="profile-avatar" style="font-size: 2em; margin: 0 auto 20px;">üòä</div><h2 id="profile-name">Your Name</h2></div>
    
    <div class="form-group">
        <label for="min-group-size">Minimum Group Size</label>
        <select id="min-group-size" onchange="saveMinimumGroupSize()">
            <option value="2">Any size (including 1-on-1)</option>
            <option value="3">At least 3 people</option>
            <option value="4">At least 4 people</option>
            <option value="5">At least 5 people</option>
        </select>
        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Only show matches with at least this many total participants</div>
    </div>
    
    <div class="form-group">
        <label for="new-username">Change Display Name</label>
        <input type="text" id="new-username" placeholder="Enter new name">
    </div>
    <button class="btn btn-secondary" onclick="changeUsername()">Update Name</button>
    
    <div class="form-group">
        <label for="new-password">Change Password</label>
        <input type="password" id="new-password" placeholder="New password (6+ characters)">
        <input type="password" id="confirm-password" placeholder="Confirm new password" style="margin-top: 10px;">
    </div>
    <button class="btn btn-secondary" onclick="changePassword()">Update Password</button>
    
    <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
    <button class="btn btn-secondary" onclick="exportData()">Export My Data</button>
    <button class="btn btn-secondary" onclick="resetApp()" style="background: #dc3545; color: white;">Reset App</button>
</div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showPage('circles')"><div class="nav-icon">üë•</div><div class="nav-label">Circles</div></div>
            <div class="nav-item" onclick="showPage('activities')"><div class="nav-icon">üéØ</div><div class="nav-label">Activities</div></div>
            <div class="nav-item" id="matches-nav-item" onclick="showPage('matches')"><div class="nav-icon">üí´</div><div class="nav-label">Matches</div><span class="notification-badge"></span></div>
            <div class="nav-item" onclick="showPage('settings')"><div class="nav-icon">‚öôÔ∏è</div><div class="nav-label">Settings</div></div>
        </div>
        
        <div class="modal-overlay" id="image-modal-overlay"><div class="close-modal" onclick="closeImageModal()">√ó</div><div class="modal-content modal-image-content"><img class="modal-image" id="modal-image" src="" alt=""></div></div>
        <div class="modal-overlay" id="circle-modal-overlay"><div class="modal-content"><span class="close-modal-btn" onclick="closeCircleModal()">√ó</span><div id="create-circle" style="display: none;"><div class="modal-header">Create New Circle</div><div class="form-group"><label for="circle-name">Circle Name</label><input type="text" id="circle-name" placeholder="e.g., College Friends"></div><button class="btn" onclick="createCircle()">Create</button></div><div id="join-circle" style="display: none;"><div class="modal-header">Join Circle</div><div class="form-group"><label for="circle-code">Circle Code</label><input type="text" id="circle-code" placeholder="Enter 6-digit code"></div><button class="btn" onclick="joinCircle()">Join</button></div></div></div>
        <div class="modal-overlay" id="suggest-modal-overlay"><div class="modal-content"><span class="close-modal-btn" onclick="closeSuggestModal()">√ó</span><div class="modal-header">Suggest an Activity</div><div class="form-group"><label for="suggest-name">Activity Name</label><input type="text" id="suggest-name" placeholder="e.g., Go Karting"></div><button class="btn" onclick="suggestActivity()">Suggest</button></div></div>
        <div class="modal-overlay" id="date-modal-overlay"><div class="modal-content"><span class="close-modal-btn" onclick="closeDateModal()">√ó</span><div class="modal-header">Schedule Activity</div><div class="form-group"><label for="event-date">Date</label><input type="date" id="event-date"></div><button class="btn" onclick="saveEvent()">Save Event</button></div></div>
        <div class="modal-overlay" id="invite-modal-overlay"><div class="modal-content"><span class="close-modal-btn" onclick="closeInviteModal()">√ó</span><div class="modal-header">Share Invite Link</div><div class="form-group"><label for="invite-link">Copy this link and send it to a friend:</label><input type="text" id="invite-link" readonly></div><button class="btn" onclick="copyInviteLink()">Copy Link</button></div></div>
    
<div class="undo-container" id="undo-container">
                    <span>Selection updated.</span>
                    <button class="undo-btn" onclick="undoLastActivityChange()">Undo</button>
                </div>
<div class="modal-overlay" id="manage-activities-modal-overlay">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeManageActivitiesModal()">√ó</span>
        <div class="modal-header">Manage Activities for This Circle</div>
        <div style="margin-bottom: 15px; font-size: 0.9em; color: #666;">
    Customize which activities appear in your activity selection. Core activities are shown by default - uncheck to hide them. Additional activities are available to add more variety to your options.
</div>
        <div id="manage-activities-grid" class="activities-grid"></div>
        <button class="btn" onclick="saveActivityVisibility()">Save Changes</button>
    </div>
</div>
</div>

    <script>
        // App State
        let currentUser = null, circles = [], selectedCircle = null, activities = [], lastActivitiesState = [], activityCounts = {}, matches = [], messages = {}, currentChatMatch = null, undoTimeout = null;


// UUID Generator
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

// Authentication functions
function showRegister() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
}

function showLogin() {
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('login-form').style.display = 'block';
}

window.signUp = async function() {
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    const name = document.getElementById('register-name').value.trim();
    const selectedAvatar = document.querySelector('#register-form .avatar-option.selected');
    
    if (!email || !password || !name || !selectedAvatar) {
        return showNotification('Please fill in all fields and select an avatar', 'error');
    }
    
    if (password.length < 6) {
        return showNotification('Password must be at least 6 characters', 'error');
    }
    
    try {
        // Sign up with Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: email,
            password: password
        });
        
        if (authError) throw authError;
        
        // Create profile with authenticated user ID
        const { data: profileData, error: profileError } = await supabase
            .from('profiles')
            .insert([{
                id: authData.user.id, // Use Supabase Auth user ID
                name: name,
                avatar: selectedAvatar.dataset.avatar
            }])
            .select()
            .single();
        
        if (profileError) throw profileError;
        
        currentUser = profileData;
	// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}
        localStorage.setItem('friendle_user', JSON.stringify(currentUser));
        
        showNotification('Account created successfully!');
        showPage('circles');
        updateProfile();
        processInvite();
        
    } catch (error) {
        console.error('Signup error:', error);
        showNotification(error.message || 'Error creating account', 'error');
    }
}

window.signIn = async function() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        return showNotification('Please enter email and password', 'error');
    }
    
    try {
        // Sign in with Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (authError) throw authError;
        
        // Load user profile
        const { data: profileData, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', authData.user.id)
            .single();
        
        if (profileError) throw profileError;
        
        currentUser = profileData;
        localStorage.setItem('friendle_user', JSON.stringify(currentUser));
        
        showNotification('Signed in successfully!');
        showPage('circles');
        updateProfile();
        processInvite();
        
    } catch (error) {
        console.error('Signin error:', error);
        showNotification(error.message || 'Error signing in', 'error');
    }
}

window.signOut = async function() {
    if (!confirm('Are you sure you want to sign out?')) return;
    
    try {
        await supabase.auth.signOut();
        currentUser = null;
        localStorage.removeItem('friendle_user');
        showPage('welcome');
        showNotification('Signed out successfully');
    } catch (error) {
        console.error('Sign out error:', error);
        showNotification('Error signing out', 'error');
    }
}

async function processInviteCode() {
    const inviteCode = sessionStorage.getItem('pending_invite_code');
    if (!inviteCode || !currentUser) return;
    
    try {
        // Find circle by code
        const { data: circle, error: circleError } = await supabase
            .from('circles')
            .select('*')
            .eq('code', inviteCode)
            .single();
        
        if (circleError || !circle) {
            showNotification('Invalid invite code', 'error');
            sessionStorage.removeItem('pending_invite_code');
            return;
        }
        
        // Check if user is already a member
        const { data: existingMember } = await supabase
            .from('circle_members')
            .select('*')
            .eq('circle_id', circle.id)
            .eq('profile_id', currentUser.id)
            .single();
        
        if (existingMember) {
            showNotification('You are already a member of this circle');
            sessionStorage.removeItem('pending_invite_code');
            return;
        }
        
        // Add user to circle
        const { error: joinError } = await supabase
            .from('circle_members')
            .insert([{ circle_id: circle.id, profile_id: currentUser.id }]);
        
        if (joinError) throw joinError;
        
        showNotification('Successfully joined "' + circle.name + '"!');
        renderCircles(); // Refresh circles display
        sessionStorage.removeItem('pending_invite_code');
        
    } catch (error) {
        console.error('Error processing invite:', error);
        showNotification('Error joining circle', 'error');
        sessionStorage.removeItem('pending_invite_code');
    }
}

        // Utility Functions
        function generateCode() { return Math.floor(100000 + Math.random() * 900000).toString(); }
        function showNotification(message, type = 'success') { /* ... */ }

        // Profile Management & Avatar Selection
       window.createProfile = async function() {
  const name = document.getElementById('name').value.trim();
  const selectedAvatar = document.querySelector('.avatar-option.selected');
  if (!name || !selectedAvatar) {
    return showNotification('Please enter a name and select an avatar', 'error');
  }

  // Create profile object with UUID
  const profileData = {
    id: generateUUID(), // Use UUID instead of letting Supabase auto-generate
    name, 
    avatar: selectedAvatar.dataset.avatar
  };

  // Insert into Supabase
  const { data, error } = await supabase
    .from('profiles')
    .insert([profileData])
    .select()
    .single();

  if (error) {
    console.error(error);
    return showNotification('Could not create profile', 'error');
  }

  currentUser = data; // store the profile from DB
  localStorage.setItem('friendle_user', JSON.stringify(currentUser)); // keep local copy for session
  showPage('circles');
  updateProfile();
  processInvite();
}

        function updateProfile() { if (currentUser) { document.getElementById('profile-name').textContent = currentUser.name; document.getElementById('profile-avatar').textContent = currentUser.avatar;
loadMinimumGroupSize(); 
	}
}

async function loadMinimumGroupSize() {
    if (!currentUser) return;
    
    const select = document.getElementById('min-group-size');
    if (select) {
        select.value = currentUser.minimum_group_size || 2;
    }
}

window.saveMinimumGroupSize = async function() {
    const select = document.getElementById('min-group-size');
    const newValue = parseInt(select.value);
    
    try {
        const { error } = await supabase
            .from('profiles')
            .update({ minimum_group_size: newValue })
            .eq('id', currentUser.id);
        
        if (error) throw error;
        
        currentUser.minimum_group_size = newValue;
        localStorage.setItem('friendle_user', JSON.stringify(currentUser));
        
        showNotification('Group size preference updated!');
        
        // Refresh matches to apply new filter
        if (selectedCircle) {
            await checkForMatches();
            renderMatches();
        }
    } catch (error) {
        console.error('Error saving minimum group size:', error);
        showNotification('Error saving preference', 'error');
    }
}

window.changeUsername = async function() {
    const newName = document.getElementById('new-username').value.trim();
    
    if (!newName) {
        return showNotification('Please enter a name', 'error');
    }
    
    try {
        const { error } = await supabase
            .from('profiles')
            .update({ name: newName })
            .eq('id', currentUser.id);
        
        if (error) throw error;
        
        currentUser.name = newName;
        localStorage.setItem('friendle_user', JSON.stringify(currentUser));
        
        updateProfile();
        document.getElementById('new-username').value = '';
        
        showNotification('Name updated successfully!');
        
    } catch (error) {
        console.error('Error changing username:', error);
        showNotification('Error updating name', 'error');
    }
}

window.changePassword = async function() {
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (!newPassword || !confirmPassword) {
        return showNotification('Please fill in both password fields', 'error');
    }
    
    if (newPassword.length < 6) {
        return showNotification('New password must be at least 6 characters', 'error');
    }
    
    if (newPassword !== confirmPassword) {
        return showNotification('Passwords do not match', 'error');
    }
    
    try {
        const { error } = await supabase.auth.updateUser({
            password: newPassword
        });
        
        if (error) throw error;
        
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        
        showNotification('Password updated successfully!');
        
    } catch (error) {
        console.error('Error changing password:', error);
        showNotification(error.message || 'Error updating password', 'error');
    }
}

        document.querySelectorAll('.avatar-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // Circle Management
        window.showCreateCircle = () => { document.getElementById('create-circle').style.display = 'block'; document.getElementById('circle-modal-overlay').style.display = 'flex'; };
        window.showJoinCircle = () => { document.getElementById('join-circle').style.display = 'block'; document.getElementById('circle-modal-overlay').style.display = 'flex'; };
        window.closeCircleModal = () => { document.getElementById('circle-modal-overlay').style.display = 'none'; document.getElementById('create-circle').style.display = 'none'; document.getElementById('join-circle').style.display = 'none'; };
        window.createCircle = async function() {
  const name = document.getElementById('circle-name').value.trim();
  if (!name) return;

  const code = generateCode();

  // Insert into circles
  const { data: circle, error } = await supabase
    .from('circles')
    .insert([{ name, code, created_by: currentUser.id }])
    .select()
    .single();

  if (error) {
    console.error(error);
    return showNotification('Could not create circle', 'error');
  }

  // Add creator as a member
  await supabase.from('circle_members').insert([{ circle_id: circle.id, profile_id: currentUser.id }]);

  circles.push(circle);
  closeCircleModal();
  renderCircles();
  showNotification(`Circle created! Share code: ${circle.code}`);
}

        
        window.joinCircle = async function() {
  const code = document.getElementById('circle-code').value.trim();
  if (!code) return;

  // Find the circle by code
  const { data: circle, error } = await supabase
    .from('circles')
    .select('*')
    .eq('code', code)
    .single();

  if (error || !circle) {
    return showNotification('Circle not found', 'error');
  }

  // Add user to circle_members
  await supabase.from('circle_members').insert([{ circle_id: circle.id, profile_id: currentUser.id }]);

  circles.push(circle);
  closeCircleModal();
  renderCircles();
  showNotification(`Joined Circle!`);
}

        async function renderCircles() {
  try {
    // Get circles with member counts
    const { data, error } = await supabase
      .from('circle_members')
      .select(`
        circle_id, 
        circles(*),
        profile_id
      `)
      .eq('profile_id', currentUser.id);

    if (error) throw error;

    circles = data.map(d => d.circles);

    // Get member counts for each circle
    const circleIds = circles.map(c => c.id);
    const { data: memberCounts, error: countError } = await supabase
      .from('circle_members')
      .select('circle_id')
      .in('circle_id', circleIds);

    if (countError) throw countError;

    // Count members per circle
    const counts = {};
    memberCounts.forEach(member => {
      counts[member.circle_id] = (counts[member.circle_id] || 0) + 1;
    });

    const list = document.getElementById('circles-list');
    list.innerHTML = circles.map(circle => {
      const memberCount = counts[circle.id] || 0;
      const memberText = memberCount === 1 ? '1 member' : `${memberCount} members`;
      
      return `
        <div class="circle-card">
          <div class="main-content" onclick='selectCircle("${circle.id}")'>
            <div class="circle-name">${circle.name}</div>
            <div class="circle-members">${memberText}</div>
            <div class="circle-code">Invite Code: <strong>${circle.code}</strong></div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
    <div style="display: flex; gap: 8px;">
        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); copyCircleCode('${circle.code}')" style="flex: 1;">Copy Code</button>
        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); inviteByEmail('${circle.name}', '${circle.code}')" style="flex: 1;">Invite</button>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); renameCircle('${circle.id}')" style="flex: 1;">Rename</button>
        <button class="btn btn-small" onclick="event.stopPropagation(); leaveCircle('${circle.id}')" style="background: #dc3545; flex: 1;">Leave</button>
    </div>
</div>
        </div>`;
    }).join('');
  } catch (error) {
    console.error('Error loading circles:', error);
    circles = [];
  }
}


window.leaveCircle = async function(circleId) {
  if (!confirm("Are you sure you want to leave this circle?")) return;

  // Delete your membership row from circle_members
  const { error } = await supabase
    .from('circle_members')
    .delete()
    .eq('circle_id', circleId)
    .eq('profile_id', currentUser.id);

  if (error) {
    console.error(error);
    return showNotification("Error leaving circle", "error");
  }

  // Refresh circles list
  await renderCircles();
  showNotification("You left the circle.");
};

window.copyCircleCode = function(code) {
    navigator.clipboard.writeText(code).then(() => {
        showNotification('Circle code ' + code + ' copied to clipboard!');
    }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Circle code ' + code + ' copied to clipboard!');
    });
}

window.inviteByEmail = function(circleName, circleCode) {
    const subject = encodeURIComponent('Join my "' + circleName + '" circle on Friendle');
    const appUrl = 'https://friendle-circles.vercel.app/'; // Update this to your actual URL
    const inviteUrl = appUrl + '?invite_code=' + circleCode;
    
    const body = encodeURIComponent(
    'Hi! I would like to invite you to join my "' + circleName + '" circle on Friendle.\n\n' +
    'Friendle helps friends coordinate activities together.\n\n' +
    'CLICK THIS LINK TO JOIN:\n' +
    inviteUrl + '\n\n' +
    '(Copy and paste the link above into your browser if it does not appear clickable)\n\n' +
    'Or visit ' + appUrl + ' and manually enter code: ' + circleCode + '\n\n' +
    'Looking forward to planning some fun activities together!'
);
    
    const mailtoLink = 'mailto:?subject=' + subject + '&body=' + body;
    window.open(mailtoLink, '_self');
}

window.renameCircle = async function(circleId) {
    const circle = circles.find(c => c.id === circleId);
    const newName = prompt('Enter new circle name:', circle.name);
    
    if (newName && newName.trim() && newName.trim() !== circle.name) {
        try {
            const { error } = await supabase
                .from('circles')
                .update({ name: newName.trim() })
                .eq('id', circleId)
                .eq('created_by', currentUser.id); // Only creator can rename

            if (error) throw error;
            
            showNotification('Circle renamed!');
            renderCircles(); // Refresh the display
        } catch (error) {
            console.error('Error renaming circle:', error);
            showNotification('Error renaming circle', 'error');
        }
    }
}

// Save user preferences to Supabase
async function saveUserPreferences(circleId, selectedActivityIds) {
    try {
        console.log('Saving preferences for circle:', circleId);
        console.log('Selected activity IDs:', selectedActivityIds);
        console.log('Current user ID:', currentUser.id);

        // First, clear existing preferences for this circle
        const { error: deleteError } = await supabase
            .from('preferences')
            .delete()
            .eq('profile_id', currentUser.id)
            .eq('circle_id', circleId);

        if (deleteError) {
            console.error('Delete error:', deleteError);
            throw deleteError;
        }

        // Then insert new preferences (only if there are selections)
        if (selectedActivityIds.length > 0) {
            const preferences = selectedActivityIds.map(activityId => ({
                profile_id: currentUser.id,
                circle_id: circleId,
                activity_id: activityId.toString(), // Convert to string
                selected: true
            }));

            console.log('Preferences to insert:', preferences);

            const { error: insertError } = await supabase
                .from('preferences')
                .insert(preferences);

            if (insertError) {
                console.error('Insert error:', insertError);
                throw insertError;
            }
        }
        
        showNotification('Preferences saved!');
    } catch (error) {
        console.error('Error saving preferences:', error);
        showNotification('Error saving preferences', 'error');
    }
}

// Load user preferences from Supabase
async function loadUserPreferences(circleId) {
    try {
        const { data, error } = await supabase
            .from('preferences')
            .select('activity_id')
            .eq('profile_id', currentUser.id)
            .eq('circle_id', circleId)
            .eq('selected', true);

        if (error) throw error;
        
        return data.map(pref => pref.activity_id);
    } catch (error) {
        console.error('Error loading preferences:', error);
        return [];
    }
}

        window.selectCircle = async function(circleId) {
    selectedCircle = circles.find(c => c.id === circleId);
    
    // Load preferences from Supabase instead of localStorage
    const savedActivityIds = await loadUserPreferences(selectedCircle.id);
    const allActivities = await loadActivities(selectedCircle.id);
    
    // Rebuild the activities array from saved preferences
    activities = allActivities.filter(activity => savedActivityIds.includes(activity.id));
    
    showPage('activities');
    document.getElementById('activity-circle-name').textContent = selectedCircle.name;
    renderActivities();
}

async function loadActivities(circleId) {
    try {
        const { data: customActivities, error: activitiesError } = await supabase
            .from('activities')
            .select('*')
            .eq('circle_id', circleId);
        
        if (activitiesError) throw activitiesError;
        
        // Get circle-level activity visibility (member-controlled)
        const { data: circleActivities, error: visibilityError } = await supabase
            .from('circle_activities')
            .select('activity_id, is_visible')
            .eq('circle_id', circleId);
        
        if (visibilityError) throw visibilityError;
        
        // Build map of activity visibility
        const visibilityMap = {};
        circleActivities?.forEach(ca => {
            visibilityMap[ca.activity_id] = ca.is_visible;
        });
        
        // Filter default activities based on circle visibility settings
        // If not in map, core activities default to visible, extended default to hidden
        const visibleDefaultActivities = defaultActivities.filter(a => {
            if (visibilityMap.hasOwnProperty(a.id)) {
                return visibilityMap[a.id]; // Use explicit setting
            }
            // Default: core visible, extended hidden
            return coreActivityIds.includes(a.id);
        });
        
        return [...visibleDefaultActivities, ...customActivities];
    } catch (error) {
        console.error('Error loading activities:', error);
        return [];
    }
}

let coreActivityIds = [];
let extendedActivityIds = [];
let defaultActivities = [];

async function loadDefaultActivities() {
    try {
        // Load all default activities from database (where circle_id is null)
        const { data, error } = await supabase
            .from('activities')
            .select('*')
            .is('circle_id', null);
        
        if (error) throw error;
        
        defaultActivities = data;
        
        // Split into core and extended based on a category or naming convention
        // For now, let's say activities with IDs < 200 are core (adjust as needed)
        coreActivityIds = data.filter(a => {
            // Define which activities are "core" - adjust these names as needed
            const coreNames = ['Coffee', 'Dinner', 'Drinks', 'Brunch', 'Pizza Night', 'Ice Cream',
                               'Hiking', 'Beach', 'Bowling', 'Walk in the Park',
                               'Movie', 'Trivia Night', 'Arcade', 'Board Games'];
            return coreNames.includes(a.name);
        }).map(a => a.id);
        
        extendedActivityIds = data.filter(a => !coreActivityIds.includes(a.id)).map(a => a.id);
        
        console.log('Loaded default activities:', defaultActivities);
        console.log('Core activity IDs:', coreActivityIds);
        
    } catch (error) {
        console.error('Error loading default activities:', error);
    }
}
        // Activity Management
        async function renderActivities(searchTerm = '') {
    const frequentGrid = document.getElementById('frequent-grid');
    const activitiesGrid = document.getElementById('activities-grid');
    frequentGrid.innerHTML = ''; 
    activitiesGrid.innerHTML = '';
    
    const sortedCounts = Object.entries(activityCounts).sort(([,a],[,b]) => b-a);
    const frequentIds = sortedCounts.slice(0, 4).map(([id]) => parseInt(id));
    
    // Load activities from both default + Supabase
    const allPossibleActivities = await loadActivities(selectedCircle.id);
    
    const filteredActivities = allPossibleActivities.filter(a => 
        a.name.toLowerCase().includes(searchTerm.toLowerCase())
    );

    const frequentActivities = filteredActivities.filter(a => frequentIds.includes(a.id));
    document.getElementById('frequent-section').style.display = 
        frequentActivities.length > 0 && !searchTerm ? 'block' : 'none';
    frequentActivities.forEach(activity => createActivityCard(activity, frequentGrid));

    const nonFrequentActivities = filteredActivities.filter(a => !frequentIds.includes(a.id));
    nonFrequentActivities.forEach(activity => createActivityCard(activity, activitiesGrid));
}
        function createActivityCard(activity, grid) {
            const card = document.createElement('div');
            card.className = 'activity-card';
            if (activities.some(a => a.id === activity.id)) card.classList.add('selected');
            card.innerHTML = `<div class="activity-emoji">${activity.emoji}</div><div class="activity-name">${activity.name}</div>`;
            card.onclick = (event) => {
                event.stopPropagation();
                toggleActivity(card, activity);
            };
            grid.appendChild(card);
        }
        function toggleActivity(card, activity) {
            lastActivitiesState = [...activities];
            card.classList.toggle('selected');
            const index = activities.findIndex(a => a.id === activity.id);
            if (index > -1) activities.splice(index, 1);
            else activities.push(activity);
        }
        window.handleSearch = (event) => renderActivities(event.target.value);
        window.selectBulk = function(type) {
            lastActivitiesState = [...activities];
            const all = [...defaultActivities, ...(selectedCircle.customActivities || [])];
            activities = type === 'clear' ? [] : all.filter(a => a.category === type);
            renderActivities();
        }
        window.saveActivities = async function() {
    if (!selectedCircle) return showNotification('Please select a circle first', 'error');
    
    console.log('=== SAVING ACTIVITIES ===');
    console.log('Current user:', currentUser.id);
    console.log('Selected circle:', selectedCircle.id);
    console.log('Selected activities:', activities);
    
    const selectedActivityIds = activities.map(activity => activity.id);
    console.log('Activity IDs to save:', selectedActivityIds);
    
    await saveUserPreferences(selectedCircle.id, selectedActivityIds);
    
    activities.forEach(act => { 
        activityCounts[act.id] = (activityCounts[act.id] || 0) + 1; 
    });
    localStorage.setItem('friendle_activity_counts', JSON.stringify(activityCounts));
    
    console.log('=== CHECKING FOR MATCHES ===');
    await checkForMatches();
    showPage('matches');
}
        window.openSuggestModal = () => document.getElementById('suggest-modal-overlay').style.display = 'flex';
        window.closeSuggestModal = () => document.getElementById('suggest-modal-overlay').style.display = 'none';
        window.suggestActivity = async function() {
    const name = document.getElementById('suggest-name').value.trim();
    if (!name) { 
        return showNotification('Please provide an activity name', 'error'); 
    }

    try {
        const { data, error } = await supabase
            .from('activities')
            .insert([{
                name: name,
                emoji: 'üí°', // Always use lightbulb
                category: 'custom',
                circle_id: selectedCircle.id
            }])
            .select()
            .single();

        if (error) throw error;
        
        showNotification(`Activity "${name}" added!`);
        closeSuggestModal(); 
        renderActivities();
    } catch (error) {
        console.error('Error adding custom activity:', error);
        showNotification('Error adding activity', 'error');
    }
}
        function showUndo() {
            const undoContainer = document.getElementById('undo-container');
            undoContainer.style.display = 'flex';
            clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => {
                undoContainer.style.display = 'none';
            }, 8000);
        }
        window.undoLastActivityChange = function() {
            activities = [...lastActivitiesState];
            renderActivities();
            document.getElementById('undo-container').style.display = 'none';
            clearTimeout(undoTimeout);
        }
// Replace your findMatches function with this version:
async function findMatches(circleId) {
    try {
        // Get current user's preferences
        const userPrefs = await loadUserPreferences(circleId);
        if (userPrefs.length === 0) {
            return [];
        }

        const groupMatches = [];

        // For each activity the user likes, find or create a group match
        for (const activityId of userPrefs) {
            // Check if a group match already exists for this activity in this circle
            const { data: existingMatch, error: matchError } = await supabase
                .from('matches')
                .select(`
                    *,
                    activities(id, name, emoji, category),
                    match_participants(profile_id, profiles(id, name, avatar))
                `)
                .eq('circle_id', circleId)
                .eq('activity_id', activityId)
                .single();

            if (matchError && matchError.code !== 'PGRST116') {
                console.error('Error checking for existing match:', matchError);
                continue;
            }

            let match;
            
            if (existingMatch) {
                // Group match exists, check if user is already in it
                const isUserInGroup = existingMatch.match_participants.some(p => p.profile_id === currentUser.id);
                
                if (!isUserInGroup) {
                    // Add user to existing group
                    await supabase
                        .from('match_participants')
                        .insert([{ match_id: existingMatch.id, profile_id: currentUser.id }]);
                }
                
                match = existingMatch;
            } else {
                // Create new group match for this activity
                const { data: newMatch, error: createError } = await supabase
                    .from('matches')
                    .insert([{
                        circle_id: circleId,
                        activity_id: activityId
                    }])
                    .select(`
                        *,
                        activities(id, name, emoji, category)
                    `)
                    .single();

                if (createError) {
                    console.error('Error creating match:', createError);
                    continue;
                }

                // Add current user as first participant
                await supabase
                    .from('match_participants')
                    .insert([{ match_id: newMatch.id, profile_id: currentUser.id }]);

                match = { ...newMatch, match_participants: [{ profile_id: currentUser.id, profiles: currentUser }] };
            }

            // Get all participants for this match
            const { data: participants, error: participantError } = await supabase
                .from('match_participants')
                .select(`
                    profile_id,
                    profiles(id, name, avatar)
                `)
                .eq('match_id', match.id)
                .neq('profile_id', currentUser.id); // Exclude current user

            if (participantError) {
                console.error('Error loading participants:', participantError);
                continue;
            }

            // Only show matches that have other participants
            if (participants.length > 0) {
                groupMatches.push({
                    id: match.id,
                    isGroupChat: participants.length > 1, // True if more than 2 total people
                    circleId: circleId,
                    users: participants.map(p => p.profiles),
                    activity: match.activities,
                    isRead: false,
                    scheduledDate: match.scheduled_date ? new Date(match.scheduled_date) : null
                });
            }
        }

        return groupMatches;
    } catch (error) {
        console.error('Error finding matches:', error);
        return [];
    }
}
// Save matches to Supabase
async function saveMatchesToSupabase(matches, circleId) {
    try {
        // Clear existing matches for this user and circle
        await supabase
            .from('matches')
            .delete()
            .eq('circle_id', circleId);

        // Insert new matches
        if (matches.length > 0) {
            const matchData = matches.map(match => ({
                id: match.id,
                circle_id: circleId,
                activity_id: match.activity.id
                // Note: We'll need to modify your matches table structure to store user pairs
            }));

            const { error } = await supabase
                .from('matches')
                .insert(matchData);

            if (error) throw error;
        }
    } catch (error) {
        console.error('Error saving matches:', error);
    }
}
        // Match System
        async function checkForMatches() {
    if (!selectedCircle) return;
    
    console.log('Finding matches for circle:', selectedCircle.id);
    
    // Find real matches based on preferences
    const foundMatches = await findMatches(selectedCircle.id);
    
    // Update global matches array
    matches = foundMatches;
    
    console.log('Found matches:', matches);
    
    // Save to localStorage for now (we can migrate this later)
    localStorage.setItem('friendle_matches', JSON.stringify(matches));
    
    updateNotificationBadge();

if (matches.length > 0) {
    showNotification(`Found ${matches.length} new matches!`);
    
    // Show browser notification
showNotificationAlert(
    'New Activity Matches!',
    `You have ${matches.length} new friend${matches.length > 1 ? 's' : ''} ready to hang out`,
    null,
    true
);
} else {
    showNotification('No matches found yet. Try selecting more activities or invite more friends!');
}
}

async function loadAllCircleMatches() {
    matches = [];
    
    for (const circle of circles) {
        const circleMatches = await findMatches(circle.id);
        matches.push(...circleMatches);
    }
    
    localStorage.setItem('friendle_matches', JSON.stringify(matches));
    updateNotificationBadge();
}

window.renderMatches = function() {
    const list = document.getElementById('matches-list');
    const showPastEvents = document.getElementById('show-past-events')?.checked ?? true;
    const searchTerm = document.getElementById('matches-search')?.value.toLowerCase() || '';
    
    // Filter matches based on toggle and search
    let filteredMatches = matches;
    
    if (!showPastEvents) {
        filteredMatches = filteredMatches.filter(match => {
            if (!match.scheduledDate) return true;
            const scheduledDate = new Date(match.scheduledDate);
            const today = new Date();
            return scheduledDate >= today;
        });
    }
    
    if (searchTerm) {
        filteredMatches = filteredMatches.filter(match => {
            const userName = match.users.map(u => u.name).join(' ').toLowerCase();
            const activityName = match.activity?.name.toLowerCase() || '';
            return userName.includes(searchTerm) || activityName.includes(searchTerm);
        });
    }
    
    // Filter by minimum group size
    const minGroupSize = currentUser.minimum_group_size || 2;
    filteredMatches = filteredMatches.filter(match => {
        const totalParticipants = match.users.length + 1; // +1 for current user
        return totalParticipants >= minGroupSize;
    });
    
    if (filteredMatches.length === 0) {
        const message = searchTerm ? 
            'No matches found for your search.' :
            (showPastEvents ? 'No matches yet.' : 'No upcoming events. Check "Show past events" to see completed activities.');
        return list.innerHTML = `<div style="text-align: center; margin: 40px 0; color: #666;">${message}</div>`;
    }
    
    list.innerHTML = filteredMatches.map(match => {
        const title = match.isGroupChat ? 
            `${match.activity.name} Group` : 
            `${match.users[0].name} - ${match.activity.name}`;
        
        const members = match.isGroupChat ? 
            `${match.users.length + 1} members` : 
            'Chat ready';

        return `
        <div class="circle-card" onclick='openChat(${JSON.stringify(match)})'>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.5em;">${match.activity.emoji}</div>
                <div style="flex: 1;">
                    <div class="circle-name">${title}</div>
                    <div class="circle-members">${members}</div>
                </div>
                <div style="color: #667eea; font-size: 1.2em;">${!match.isRead ? 'üîî' : (match.isGroupChat ? 'üë•' : 'üí¨')}</div>
            </div>
        </div>`;
    }).join('');
}
        function renderMatches() {
            const list = document.getElementById('matches-list');
            if (matches.length === 0) return list.innerHTML = '<div style="text-align: center; margin: 40px 0; color: #666;">No matches yet.</div>';
            
            list.innerHTML = matches.map(match => {
                const title = match.isGroupChat 
                    ? `Group Chat for ${match.activity.name}` 
                    : `${match.users[0].name} for ${match.activity.name}`;
                
                const members = match.isGroupChat ? `${match.users.length + 1} Members` : `In ${match.circleName}`;

                return `
                <div class="circle-card" onclick='openChat(${JSON.stringify(match)})'>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 1.5em;">${match.activity.emoji}</div>
                        <div style="flex: 1;">
                            <div class="circle-name">${title}</div>
                            <div class="circle-members">${members}</div>
                        </div>
                        <div style="color: #667eea; font-size: 1.2em;">${!match.isRead ? 'üîî' : 'üí¨'}</div>
                    </div>
                </div>`;
            }).join('');
        }
        
async function sendMessageToSupabase(matchId, content, type = 'text', extraData = {}) {
    try {
        const { data, error } = await supabase
            .from('messages')
            .insert([{
                match_id: matchId,
                sender_id: currentUser.id,
                content: content,
                type: type,
                lat: extraData.lat || null,
                lng: extraData.lng || null
            }])
            .select(`
                *,
                profiles(id, name, avatar)
            `)
            .single();

        if (error) throw error;
        return data;
    } catch (error) {
        console.error('Error sending message:', error);
        return null;
    }
}

// Load messages from Supabase for a match
async function loadMessagesFromSupabase(matchId) {
    try {
        const { data, error } = await supabase
            .from('messages')
            .select(`
                *,
                profiles(id, name, avatar)
            `)
            .eq('match_id', matchId)
            .order('created_at', { ascending: true });

        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Error loading messages:', error);
        return [];
    }
}

        // Chat System
        window.openChat = async function(match) {
    currentChatMatch = matches.find(m => m.id === match.id);
    if(currentChatMatch) currentChatMatch.isRead = true;
    
    // Set chat header for group or individual chat
    const chatName = currentChatMatch.isGroupChat ? 
        `${currentChatMatch.activity.name} Group` : 
        currentChatMatch.users[0].name;
    
    const chatAvatar = currentChatMatch.isGroupChat ? 
        currentChatMatch.activity.emoji : 
        currentChatMatch.users[0].avatar;
    
    document.getElementById('chat-name').textContent = chatName;
    document.getElementById('chat-avatar').textContent = chatAvatar;
    
    // Update subtitle for group chats
    const subtitle = currentChatMatch.isGroupChat ? 
        `${currentChatMatch.users.length + 1} members: You, ${currentChatMatch.users.map(u => u.name).join(', ')}` :
        currentChatMatch.activity.name;
    
    document.getElementById('chat-activity').textContent = subtitle;

    // Load messages from Supabase
    const supabaseMessages = await loadMessagesFromSupabase(currentChatMatch.id);
    
    // Convert Supabase messages to your existing format
messages[currentChatMatch.id] = supabaseMessages.map(msg => ({
    id: msg.id,
    sender: msg.profiles.name,
    sender_id: msg.sender_id,  // ADD THIS LINE
    content: msg.content,
    type: msg.type,
    lat: msg.lat,
    lng: msg.lng,
    created_at: msg.created_at,
    isRead: true
}));

    renderChatMessages(); 
    showPage('chat');
    
    // Set up real-time subscription for this chat
    setupRealtimeMessages(currentChatMatch.id);
    
    localStorage.setItem('friendle_matches', JSON.stringify(matches));
    localStorage.setItem('friendle_messages', JSON.stringify(messages));
    localStorage.setItem('friendle_current_chat', JSON.stringify(currentChatMatch));    
updateNotificationBadge();
}

window.leaveChat = async function() {
    // Clean up real-time subscription
    cleanupRealtimeMessages();
    localStorage.removeItem('friendle_current_chat');
    
    if (!confirm('Change of plans? You can rejoin by reselecting this activity.')) {
        return;
    }
    
    try {
        // Remove user from match participants
        const { error: deleteError } = await supabase
            .from('match_participants')
            .delete()
            .eq('match_id', currentChatMatch.id)
            .eq('profile_id', currentUser.id);
        
        if (deleteError) throw deleteError;
        
        // Also remove this activity from user's preferences
        const { error: prefError } = await supabase
            .from('preferences')
            .delete()
            .eq('profile_id', currentUser.id)
            .eq('circle_id', currentChatMatch.circleId)
            .eq('activity_id', currentChatMatch.activity.id);
        
        if (prefError) throw prefError;
        
        // Update local activities array to remove this activity
        const activityIndex = activities.findIndex(a => a.id === currentChatMatch.activity.id);
        if (activityIndex > -1) {
            activities.splice(activityIndex, 1);
        }
        
        // Remove from local matches array
        const matchIndex = matches.findIndex(m => m.id === currentChatMatch.id);
        if (matchIndex > -1) {
            matches.splice(matchIndex, 1);
            localStorage.setItem('friendle_matches', JSON.stringify(matches));
        }
        
        showNotification('You left the chat');
        showPage('matches');
        renderMatches();
        
    } catch (error) {
        console.error('Error leaving chat:', error);
        showNotification('Error leaving chat', 'error');
    }
}
        function renderChatMessages() {
    console.log('üé¨ renderChatMessages called');
    const chatMessages = document.getElementById('chat-messages');
    console.log('Chat container:', chatMessages);
    console.log('Messages to render:', messages[currentChatMatch.id]);
    chatMessages.innerHTML = '';
    (messages[currentChatMatch.id] || []).forEach(msg => {
        const div = document.createElement('div');
        
        // Determine if this message is from current user by comparing IDs
        const isOwnMessage = msg.sender_id === currentUser.id;
        
        div.className = `message ${isOwnMessage ? 'own' : ''} ${msg.type === 'system' ? 'system' : ''}`;
        let bubble = '';
        if (msg.type === 'photo') bubble = `<img src="${msg.content}" class="message-photo" onclick="openImageModal('${msg.content}')">`;
        else if (msg.type === 'location') bubble = `<div class="message-location" onclick="openMap(${msg.lat}, ${msg.lng})">üìç Location Shared</div>`;
        else if (msg.type === 'text') bubble = `<div class="message-bubble">${msg.content}</div>`;
        else { div.textContent = msg.content; }
        
        if (msg.type !== 'system') {
            const senderName = isOwnMessage ? 'You' : msg.sender;
            const avatar = isOwnMessage ? currentUser.avatar : (currentChatMatch.users.find(u => u.name === msg.sender)?.avatar || 'üë§');
            
            const timestamp = msg.created_at ? 
                new Date(msg.created_at + 'Z').toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

            div.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-sender">${senderName}${timestamp ? '<span class="message-timestamp">' + timestamp + '</span>' : ''}</div>
                    ${bubble}
                </div>`;
            
            // Add message actions using DOM manipulation for own messages
            if (isOwnMessage) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                const actionsBtn = document.createElement('button');
                actionsBtn.className = 'message-actions-btn';
                actionsBtn.textContent = '...';
                actionsBtn.onclick = () => toggleMessageActions(msg.id);
                
                const actionsMenu = document.createElement('div');
                actionsMenu.className = 'message-actions-menu';
                actionsMenu.id = `menu-${msg.id}`;
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => editMessage(msg.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteMessage(msg.id);
                
                actionsMenu.appendChild(editBtn);
                actionsMenu.appendChild(deleteBtn);
                actionsDiv.appendChild(actionsBtn);
                actionsDiv.appendChild(actionsMenu);
                div.appendChild(actionsDiv);
            }
        }
        chatMessages.appendChild(div);
    });
    // Force scroll after DOM updates
setTimeout(() => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}, 100);
    const banner = document.getElementById('scheduled-event-banner-container');
    banner.innerHTML = currentChatMatch.scheduledDate ? `<div class="scheduled-event-banner">üóìÔ∏è Event scheduled for ${new Date(currentChatMatch.scheduledDate).toLocaleDateString()}</div>` : '';
}
        window.sendMessage = async function() {
    const input = document.getElementById('message-input');
    if (!input.value.trim()) return;
    
    console.log('Sending message, current user:', currentUser);
    
    // Send to Supabase
    const savedMessage = await sendMessageToSupabase(currentChatMatch.id, input.value.trim(), 'text');
    
    if (savedMessage) {
        // Add to local messages for immediate display
        const message = {
            id: savedMessage.id,
            sender: currentUser.name,
            sender_id: currentUser.id,  // Make sure this is set
            content: savedMessage.content,
            type: savedMessage.type,
            lat: savedMessage.lat,
            lng: savedMessage.lng,
            created_at: savedMessage.created_at,
            isRead: true
        };
        
        console.log('Message object:', message);
        
        if (!messages[currentChatMatch.id]) messages[currentChatMatch.id] = [];
        messages[currentChatMatch.id].push(message);
        
        // Broadcast to other users via Realtime
        const channel = supabase.channel(`match_${currentChatMatch.id}`);
        await channel.send({
            type: 'broadcast',
            event: 'new_message',
            payload: {
                id: savedMessage.id,
                sender_id: currentUser.id,  // Make sure this is included
                sender_name: currentUser.name,
                content: savedMessage.content,
                type: savedMessage.type,
                lat: savedMessage.lat,
                lng: savedMessage.lng,
                created_at: savedMessage.created_at
            }
        });
        
        console.log('Broadcast sent with sender_id:', currentUser.id);
        
        // Update localStorage
        localStorage.setItem('friendle_messages', JSON.stringify(messages));
        renderChatMessages();
    }
    
    input.value = '';
}
        async function addMessage(content, type, extraData = {}) {
    // Send to Supabase
    const savedMessage = await sendMessageToSupabase(currentChatMatch.id, content, type, extraData);
    
    if (savedMessage) {
        // Add to local messages for immediate display
        const message = {
            id: savedMessage.id,
            sender: currentUser.name,
            content: savedMessage.content,
            type: savedMessage.type,
            lat: savedMessage.lat,
            lng: savedMessage.lng,
            isRead: true
        };
        
        if (!messages[currentChatMatch.id]) messages[currentChatMatch.id] = [];
        messages[currentChatMatch.id].push(message);
        
        localStorage.setItem('friendle_messages', JSON.stringify(messages));
        renderChatMessages();
    }
}
        function simulateResponse() {
            const otherUsers = currentChatMatch.users.filter(u => u.name !== currentUser.name);
            const randomUser = otherUsers[Math.floor(Math.random() * otherUsers.length)];
            const response = { id: Date.now(), sender: randomUser.name, content: "Sounds good! üëç", isRead: false, type: 'text' };
            if (!messages[currentChatMatch.id]) messages[currentChatMatch.id] = [];
            messages[currentChatMatch.id].push(response);
            localStorage.setItem('friendle_messages', JSON.stringify(messages));
            if (document.getElementById('chat').classList.contains('active')) renderChatMessages();
            updateNotificationBadge();
        }
        window.handleMessageKeyPress = e => { if (e.key === 'Enter') sendMessage(); };
        window.openDateModal = () => document.getElementById('date-modal-overlay').style.display = 'flex';
        window.closeDateModal = () => document.getElementById('date-modal-overlay').style.display = 'none';
        window.saveEvent = async function() {
    const date = document.getElementById('event-date').value;
    if (!date) return;
    const eventDate = new Date(date.replace(/-/g, '/'));
    
    try {
        // Save to Supabase
        const { error } = await supabase
            .from('matches')
            .update({ scheduled_date: eventDate.toISOString() })
            .eq('id', currentChatMatch.id);

        if (error) throw error;

        // Update local data
        currentChatMatch.scheduledDate = eventDate;
        const matchIndex = matches.findIndex(m => m.id === currentChatMatch.id);
        if (matchIndex > -1) {
            matches[matchIndex].scheduledDate = eventDate;
        }
        
        localStorage.setItem('friendle_matches', JSON.stringify(matches));
        addMessage(`üìÖ ${currentUser.name} scheduled this for ${eventDate.toLocaleDateString()}`, 'system');
        closeDateModal();
    } catch (error) {
        console.error('Error saving event:', error);
        showNotification('Error saving event', 'error');
    }
}
        window.toggleMessageActions = function(msgId) {
            const menu = document.getElementById(`menu-${msgId}`);
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        window.editMessage = async function(msgId) {
    const message = messages[currentChatMatch.id].find(m => m.id === msgId);
    const newContent = prompt('Edit your message:', message.content);
    if (newContent) {
        try {
            const { error } = await supabase
                .from('messages')
                .update({ content: newContent })
                .eq('id', msgId)
                .eq('sender_id', currentUser.id); // Only allow editing own messages

            if (error) throw error;

            // Update local message
            message.content = newContent;
            localStorage.setItem('friendle_messages', JSON.stringify(messages));
            renderChatMessages();
        } catch (error) {
            console.error('Error editing message:', error);
            showNotification('Error editing message', 'error');
        }
    }
}
        window.deleteMessage = async function(msgId) {
    if (!confirm('Delete this message?')) return;
    
    try {
        const { error } = await supabase
            .from('messages')
            .delete()
            .eq('id', msgId)
            .eq('sender_id', currentUser.id); // Only allow deleting own messages

        if (error) throw error;

        // Remove from local messages
        const index = messages[currentChatMatch.id].findIndex(m => m.id === msgId);
        if (index > -1) {
            messages[currentChatMatch.id].splice(index, 1);
            localStorage.setItem('friendle_messages', JSON.stringify(messages));
            renderChatMessages();
        }
    } catch (error) {
        console.error('Error deleting message:', error);
        showNotification('Error deleting message', 'error');
    }
}
        
        // Attachments & Modals
        window.sharePhoto = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment';
    
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showNotification('Uploading photo...');
        
        try {
            const fileName = `${Date.now()}-${file.name}`;
            const { data, error } = await supabase.storage
                .from('chat-photos')
                .upload(fileName, file);
            
            if (error) throw error;
            
            const { data: { publicUrl } } = supabase.storage
                .from('chat-photos')
                .getPublicUrl(fileName);
            
            addMessage(publicUrl, 'photo');
            showNotification('Photo shared!');
            
        } catch (error) {
            console.error('Error uploading photo:', error);
            showNotification('Error uploading photo', 'error');
        }
    };
    
    input.click();
}
        window.shareLocation = () => navigator.geolocation.getCurrentPosition(pos => addMessage('Location Shared', 'location', { lat: pos.coords.latitude, lng: pos.coords.longitude }), () => showNotification('Could not get location', 'error'));
        window.findNearbyPlaces = function() {
            if (!navigator.geolocation) {
                return alert("Geolocation is not supported by this browser. This feature works best on a mobile device.");
            }
            showNotification("Getting your location...");
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const query = currentChatMatch.activity.name;
                    const url = `https://www.google.com/maps/search/[activity${query}/@${latitude},${longitude},14z`;
                    window.open(url, '_blank');
                },
                () => {
                    alert("Unable to retrieve your location. Please ensure location services are enabled. This feature works best on a mobile device.");
                }
            );
        }
        window.openImageModal = src => { document.getElementById('modal-image').src = src; document.getElementById('image-modal-overlay').style.display = 'flex'; };
        window.closeImageModal = () => document.getElementById('image-modal-overlay').style.display = 'none';
        window.openMap = (lat, lng) => window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
        function updateNotificationBadge() {
            const hasUnread = matches.some(m => !m.isRead) || Object.values(messages).flat().some(msg => !msg.isRead && msg.sender !== currentUser.name);
            document.querySelector('#matches-nav-item .notification-badge').style.display = hasUnread ? 'block' : 'none';
        }
        window.showPage = async function(pageId) {
    // Clear current chat match when leaving chat page
    if (pageId !== 'chat') {
        currentChatMatch = null;  // ADD THIS LINE
        localStorage.removeItem('friendle_current_chat');
    }
    
    localStorage.setItem('friendle_current_page', pageId);
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`.nav-item[onclick="showPage('${pageId}')"]`)?.classList.add('active');
    if (pageId === 'circles') renderCircles();
    if (pageId === 'matches') {
        if (selectedCircle) {
            await checkForMatches();
        } else {
            await loadAllCircleMatches();
        }
        renderMatches();
    }
}
        window.resetApp = () => { if (confirm('Are you sure?')) { localStorage.clear(); location.reload(); } };
        
        // Invite System
        window.showInviteModal = function(circleId) {
            const baseUrl = window.location.href.split('?')[0];
            const inviteToken = `invite_${circleId}_${Date.now()}`;
            const inviteLink = `${baseUrl}?invite_token=${inviteToken}`;
            document.getElementById('invite-link').value = inviteLink;
            document.getElementById('invite-modal-overlay').style.display = 'flex';
        }
        window.closeInviteModal = () => document.getElementById('invite-modal-overlay').style.display = 'none';
        window.copyInviteLink = function() {
            const linkInput = document.getElementById('invite-link');
            linkInput.select();
            document.execCommand('copy');
            showNotification('Link copied to clipboard!');
        }
        function processInvite() {
            const token = sessionStorage.getItem('pending_invite');
            if (token && currentUser) {
                const allCircles = JSON.parse(localStorage.getItem('friendle_circles') || '[]');
                const circleId = parseInt(token.split('_')[1]);
                const circle = allCircles.find(c => c.id === circleId);
                if (circle && !circle.members.some(m => m.id === currentUser.id)) {
                    circle.members.push(currentUser);
                    localStorage.setItem('friendle_circles', JSON.stringify(allCircles));
                    circles = allCircles; // Make sure our in-memory list is updated
                    showNotification(`Invite accepted! You've joined "${circle.name}".`);
                }
                sessionStorage.removeItem('pending_invite');
                renderCircles(); // Re-render to show the new circle membership
            }
}

        async function initApp() {
await loadDefaultActivities();
    const urlParams = new URLSearchParams(window.location.search);
    const inviteCode = urlParams.get('invite_code');
    
    // Store invite code for after authentication
    if (inviteCode) {
        sessionStorage.setItem('pending_invite_code', inviteCode);
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Check for existing Supabase auth session
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session) {
        // User is authenticated, load their profile
        try {
            const { data: profileData, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();
            
            if (error) throw error;
            
            currentUser = profileData;
// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}
        localStorage.setItem('friendle_user', JSON.stringify(currentUser));
        
        // Load circles first
        await renderCircles();
        
        // Then load matches from all circles
        await loadAllCircleMatches();
        
        // Restore last page or default to circles
const lastPage = localStorage.getItem('friendle_current_page') || 'circles';

// Try to restore chat if we were on chat page
if (lastPage === 'chat') {
    const savedChat = localStorage.getItem('friendle_current_chat');
    if (savedChat) {
        try {
            const chatMatch = JSON.parse(savedChat);
            // Find the match in our loaded matches
            const foundMatch = matches.find(m => m.id === chatMatch.id);
            if (foundMatch) {
                await openChat(foundMatch);
            } else {
                showPage('circles');
            }
        } catch (e) {
            console.error('Error restoring chat:', e);
            showPage('circles');
        }
    } else {
        showPage('circles');
    }
} else if (lastPage === 'activities' && !selectedCircle) {
    showPage('circles');
} else {
    showPage(lastPage);
}
        
        updateProfile();
        
        // Process invite code if present
        await processInviteCode();
            
        } catch (error) {
            console.error('Error loading profile:', error);
            await supabase.auth.signOut();
            showPage('welcome');
        }
    } else {
        // No authenticated session, show login
        currentUser = null;
        localStorage.removeItem('friendle_user');
        showPage('welcome');
    }
}

// ‚úÖ Run after DOM is ready
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM ready, attaching avatar clicks...");

  const avatars = document.querySelectorAll(".avatar-option");
  console.log("Found avatars:", avatars.length);

    avatars.forEach(option => {
    option.addEventListener("click", () => {
      console.log("Avatar clicked:", option.dataset.avatar);
      avatars.forEach(o => o.classList.remove("selected"));
      option.classList.add("selected");
    });
  });

const toggle = document.getElementById('show-past-events');
  if (toggle) {
    toggle.addEventListener('change', function() {
      console.log('Toggle changed to:', this.checked);
      renderMatches();
    });
  }
window.openManageActivitiesModal = async function() {
    if (!selectedCircle) return;
    
    try {
        // Get circle-level visibility settings
const { data: circleActivities, error: visibilityError } = await supabase
    .from('circle_activities')
    .select('activity_id, is_visible')
    .eq('circle_id', selectedCircle.id);

if (visibilityError) throw visibilityError;

// Build visibility map - activities not in map use defaults (core=visible, extended=hidden)
const visibilityMap = {};
circleActivities?.forEach(ca => {
    visibilityMap[ca.activity_id] = ca.is_visible;
});
        
        const grid = document.getElementById('manage-activities-grid');
        
        // Create sections for core and extended activities
        grid.innerHTML = `
    <div style="margin-bottom: 30px;">
        <h3 style="margin-bottom: 15px; color: #555; font-size: 1.1em; font-weight: 600; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;">Core Activities</h3>
        <div class="activities-grid" id="core-activities-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
    </div>
    <div>
        <h3 style="margin-bottom: 15px; color: #555; font-size: 1.1em; font-weight: 600; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;">Additional Activities</h3>
        <div class="activities-grid" id="extended-activities-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
    </div>
`;
        
        const coreGrid = document.getElementById('core-activities-grid');
const extendedGrid = document.getElementById('extended-activities-grid');

// Get core activities from defaultActivities array
const coreActivitiesArray = defaultActivities.filter(a => coreActivityIds.includes(a.id));

// Populate core activities
// Populate core activities
coreActivitiesArray.forEach(activity => {
    const card = document.createElement('div');
    // Core activities visible by default unless explicitly set otherwise
    const isVisible = visibilityMap.hasOwnProperty(activity.id) 
        ? visibilityMap[activity.id] 
        : true;
    card.className = `activity-card ${isVisible ? 'selected' : ''}`;
    card.onclick = () => toggleActivityVisibility(card, activity.id);
    card.dataset.activityId = activity.id;
    card.innerHTML = `
        <div class="activity-emoji">${activity.emoji}</div>
        <div class="activity-name">${activity.name}</div>
    `;
    coreGrid.appendChild(card);
});

// Get extended activities from defaultActivities array
const extendedActivitiesArray = defaultActivities.filter(a => extendedActivityIds.includes(a.id));

// Populate extended activities
extendedActivitiesArray.forEach(activity => {
    const card = document.createElement('div');
    // Extended activities hidden by default unless explicitly set otherwise
    const isVisible = visibilityMap.hasOwnProperty(activity.id) 
        ? visibilityMap[activity.id] 
        : false;
    card.className = `activity-card ${isVisible ? 'selected' : ''}`;
    card.onclick = () => toggleActivityVisibility(card, activity.id);
    card.dataset.activityId = activity.id;
    card.innerHTML = `
        <div class="activity-emoji">${activity.emoji}</div>
        <div class="activity-name">${activity.name}</div>
    `;
    extendedGrid.appendChild(card);
});
        
        document.getElementById('manage-activities-modal-overlay').style.display = 'flex';
        
    } catch (error) {
        console.error('Error loading manage activities modal:', error);
    }
}

window.closeManageActivitiesModal = () => {
    document.getElementById('manage-activities-modal-overlay').style.display = 'none';
}

window.toggleActivityVisibility = function(card, activityId) {
    card.classList.toggle('selected');
    console.log('Toggled activity:', activityId, 'Selected:', card.classList.contains('selected'));
}

window.saveActivityVisibility = async function() {
    try {
        // Get selected activities from modal
        const selectedCards = document.querySelectorAll('#manage-activities-grid .activity-card.selected');
        const selectedIds = Array.from(selectedCards).map(card => card.dataset.activityId);
        
        // Get all activity IDs
        const allActivityIds = [...coreActivityIds, ...extendedActivityIds];
        
        // Prepare upsert data for all activities
        const visibilityData = allActivityIds.map(activityId => ({
            circle_id: selectedCircle.id,
            activity_id: activityId,
            is_visible: selectedIds.includes(activityId)
        }));
        
        // Upsert to circle_activities table
        const { error } = await supabase
            .from('circle_activities')
            .upsert(visibilityData, { 
                onConflict: 'circle_id,activity_id'
            });
        
        if (error) throw error;
        
        showNotification('Activity preferences updated for all circle members!');
        closeManageActivitiesModal();
        renderActivities();
    } catch (error) {
        console.error('Error saving activity visibility:', error);
        showNotification('Error saving changes', 'error');
    }
}
  initApp(); // start the app
});   // ‚úÖ only one of these, closes document.addEventListener

function showNotificationAlert(title, body, icon = null, requireHidden = false) {
    console.log('üîî showNotificationAlert called:', title, body, 'requireHidden:', requireHidden, 'document.hidden:', document.hidden);
    
    // Check if notifications are supported and permitted
    if ('Notification' in window && Notification.permission === 'granted') {
        // For messages: only skip if actively viewing that specific chat
        // For matches: only show if tab is hidden (requireHidden = true)
        if (requireHidden && !document.hidden) {
            console.log('Skipping notification - requireHidden but tab is visible');
            return;
        }
        
        const options = {
            body: body,
            vibrate: [200, 100, 200]
        };
        
        // Only add icon if it's a valid URL
        if (icon && (icon.startsWith('http://') || icon.startsWith('https://'))) {
            options.icon = icon;
        }
        
        console.log('Creating notification with options:', options);
        const notification = new Notification(title, options);
        console.log('Notification created:', notification);
    } else {
        console.log('Notifications not available. In window:', 'Notification' in window, 'Permission:', Notification.permission);
    }
}

// Real-time messaging subscription
let messageSubscription = null;

function setupRealtimeMessages(matchId) {
    console.log('=== SETTING UP REALTIME ===');
    console.log('Match ID:', matchId);
    
    // Clean up existing subscription
    if (messageSubscription) {
        console.log('Cleaning up old subscription');
        supabase.removeChannel(messageSubscription);
    }
    
    // Use Realtime Presence/Broadcast instead of postgres_changes
    messageSubscription = supabase
        .channel(`match_${matchId}`)
        .on('broadcast', { event: 'new_message' }, (payload) => {
            console.log('üîî NEW MESSAGE RECEIVED:', payload);
            
            // Don't duplicate messages we sent ourselves
            if (payload.payload.sender_id === currentUser.id) {
                console.log('‚è≠Ô∏è Skipping own message');
                return;
            }
            
            console.log('üì• Processing message from another user');
            
            // Add to local messages array
const newMessage = {
    id: payload.payload.id,
    sender: payload.payload.sender_name,
    sender_id: payload.payload.sender_id,
    content: payload.payload.content,
    type: payload.payload.type,
    lat: payload.payload.lat,
    lng: payload.payload.lng,
    created_at: payload.payload.created_at,
    isRead: true
};

if (!messages[matchId]) messages[matchId] = [];
messages[matchId].push(newMessage);
            
console.log('‚úÖ Message added to local array');

// Show notification if not viewing this specific chat
console.log('Checking notification condition:', {
    currentChatMatch: currentChatMatch?.id,
    matchId: matchId,
    shouldNotify: !currentChatMatch || currentChatMatch.id !== matchId
});

if (!currentChatMatch || currentChatMatch.id !== matchId) {
    console.log('Calling showNotificationAlert');
    showNotificationAlert(
        `New message from ${newMessage.sender}`,
        newMessage.content
    );
}

// Update UI if we're viewing this chat

// Update UI if we're viewing this chat
if (currentChatMatch && currentChatMatch.id === matchId) {
                console.log('üé® Updating UI');
                renderChatMessages();
            }
            
            // Update localStorage
            localStorage.setItem('friendle_messages', JSON.stringify(messages));
        })
        .subscribe((status) => {
            console.log('Subscription status:', status);
        });
    
    console.log('‚úÖ Subscription created');
}

function cleanupRealtimeMessages() {
    if (messageSubscription) {
        supabase.removeChannel(messageSubscription);
        messageSubscription = null;
        console.log('Unsubscribed from messages');
    }
}

</script>
</body>
</html>